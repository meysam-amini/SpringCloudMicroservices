image: 163.5.94.91:5000/maven:21

stages:
  - build
  - unit_tests
  - integration_tests
  - deploy

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository

before_script:
  # Docker login step to authenticate to the private Docker registry
  - echo $CI_REGISTRY_PASSWORD | docker login 163.5.94.91:5000 --username $CI_REGISTRY_USERNAME --password-stdin


build:
  stage: build
  tags:
    - maven
  script:
    - echo "Building the project with dev profile..."
    - mvn clean package -Pdev -Dmaven.test.skip=true
  artifacts:
    paths:
      - target/*.jar
  only:
    changes:
      - src/**/*
      - Dockerfile
      - pom.xml
    refs:
      - dev

unit_tests:
  stage: unit_tests
  tags:
    - maven
  script:
    - echo "Running Unit Tests..."
    - mvn test
  only:
    changes:
      - src/**/*
      - Dockerfile
      - pom.xml
    refs:
      - dev

integration_tests:
  stage: integration_tests
  tags:
    - maven
  script:
    - echo "Running Integration Tests with dev profile..."
    - mvn -Pdev -Dskip.ut=true verify
  only:
    - main

deploy:
  stage: deploy
  tags:
    - maven
  script:
    - echo "Building Docker images..."
    - docker-compose build  # Build Docker images based on your Dockerfile
    - echo "Tagging Docker image with latest tag..."
    - docker tag your-image-name:latest 163.5.94.91:5000/your-image-name:latest
    - echo "Pushing Docker image to registry..."
    - docker push 163.5.94.91:5000/your-image-name:latest  # Push to your private registry
    - echo "Deploying containers..."
    - docker-compose up -d  # Deploy containers after build
  only:
    - main
